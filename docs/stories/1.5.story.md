# Story 1.5: Dashboard de Gráficos Financeiros

## Visão Geral
Como um usuário do ParidadeRisco, eu quero visualizar dados históricos de ETFs e índices através de gráficos interativos, para que eu possa analisar performance, comparar ativos e tomar decisões de investimento mais informadas.

## Contexto
Esta funcionalidade expande as capacidades analíticas da plataforma, oferecendo visualizações avançadas dos dados históricos já coletados pelo sistema. A implementação utilizará Recharts integrado ao T3 Stack existente.

## Épico Relacionado
**Épico 1**: Modernização Full-Stack e Melhoria de Funcionalidades

## Stories Detalhadas

### Story 1.5.1: Foundation & Basic Charts
**Duração Estimada**: 5 dias
**Prioridade**: Alta

#### Objetivo
Estabelecer a infraestrutura básica para gráficos e implementar visualização temporal simples.

#### Critérios de Aceitação
- [x] Página `/charts` acessível e funcional
- [x] tRPC router `charts` implementado com endpoint básico
- [x] Componente `TimeSeriesChart` exibe evolução temporal de um ativo
- [x] Integração com dados do modelo `DadoHistorico`
- [x] Layout responsivo com Tailwind CSS

#### Tarefas Técnicas
1. ✅ Instalar dependências: recharts, date-fns
2. ✅ Criar `src/server/api/routers/charts.ts`
3. ✅ Implementar `src/app/(dashboard)/charts/page.tsx`
4. ✅ Criar estrutura de componentes em `src/features/charts/`
5. ✅ Implementar `TimeSeriesChart.tsx` básico

### Story 1.5.2: Multi-Asset Comparison
**Duração Estimada**: 3 dias
**Prioridade**: Alta

#### Objetivo
Permitir comparação visual de múltiplos ativos em um único gráfico.

#### Critérios de Aceitação
- [x] Seletor de múltiplos ativos funcional
- [x] Gráfico exibe múltiplas linhas com cores distintas
- [x] Normalização para retorno percentual
- [x] Legenda interativa para show/hide ativos

#### Tarefas Técnicas
1. ✅ Implementar `AssetSelector.tsx` com multi-select
2. ✅ Criar `ComparisonChart.tsx`
3. ✅ Adicionar lógica de normalização percentual
4. ✅ Implementar `ChartLegend.tsx` interativa

### Story 1.5.3: Benchmark Integration
**Duração Estimada**: 4 dias
**Prioridade**: Média

#### Objetivo
Comparar performance de cestas/portfólios contra benchmarks (índices).

#### Critérios de Aceitação
- [ ] Seleção de cestas para análise
- [ ] Comparação vs índices cadastrados (CDI, IBOVESPA, etc.)
- [ ] Cálculo e exibição de alpha/beta
- [ ] Visualização clara de outperformance/underperformance

#### Tarefas Técnicas
1. Estender tRPC router para dados de benchmark
2. Implementar `BenchmarkChart.tsx`
3. Criar lógica de cálculo de performance relativa
4. Integrar com modelos `Cesta` e `Portfolio`

### Story 1.5.4: UI Polish & Interactions
**Duração Estimada**: 3 dias
**Prioridade**: Média

#### Objetivo
Adicionar interatividade avançada e polimento da interface.

#### Critérios de Aceitação
- [x] Controles de período (30d, 90d, 1Y, 3Y, 5Y, custom)
- [x] Zoom e pan funcionais
- [x] Tooltips informativos com dados detalhados
- [x] Interface totalmente responsiva
- [x] Integração com design system existente

#### Tarefas Técnicas
1. ✅ Implementar `TimeRangeSelector.tsx`
2. ✅ Adicionar funcionalidades de zoom/pan
3. ✅ Criar tooltips customizados
4. ✅ Otimização para dispositivos móveis
5. ✅ Testes de usabilidade

## Modelos de Dados Utilizados

### DadoHistorico
```typescript
model DadoHistorico {
  id               String    @id @default(cuid())
  date             DateTime
  price            Decimal?  @db.Decimal(10, 2)
  percentageChange Decimal?  @db.Decimal(10, 4)
  ativoId          String
  ativo            Ativo     @relation(fields: [ativoId], references: [id])
  @@unique([ativoId, date])
}
```

### Ativo
```typescript
model Ativo {
  id              String               @id @default(cuid())
  ticker          String               @unique
  name            String
  type            String
  calculationType AssetCalculationType
  dadosHistoricos DadoHistorico[]
  // ...other relations
}
```

## Arquitetura Técnica

### Stack Utilizado
- **Frontend**: React 18 + Next.js 14
- **Charts**: Recharts v2.12.7
- **Styling**: Tailwind CSS + shadcn/ui
- **API**: tRPC
- **Database**: PostgreSQL + Prisma ORM
- **Utils**: date-fns para manipulação de datas

### Estrutura de Arquivos
```
src/features/charts/
├── components/
│   ├── AssetSelector.tsx           ✅ Implementado
│   ├── ChartSkeleton.tsx          ✅ Implementado
│   ├── ComparisonChart.tsx         ✅ Implementado
│   ├── EmptyStateCard.tsx          ✅ Implementado
│   ├── ErrorBoundaryCard.tsx       ✅ Implementado
│   ├── MobileDrawer.tsx            ✅ Implementado
│   ├── ProgressiveLoader.tsx       ✅ Implementado
│   ├── TimeRangeSelector.tsx       ✅ Implementado
│   ├── TimeSeriesChart.tsx         ✅ Implementado
│   └── index.ts                    ✅ Implementado
├── types/
│   └── charts.ts                   ✅ Implementado
└── utils/
    └── calculations.ts             ✅ Implementado
```

## Riscos e Mitigações

### Riscos Técnicos
| Risco | Probabilidade | Impacto | Mitigação |
|-------|--------------|---------|-----------|
| Performance com grandes datasets | Média | Alto | Pagination, lazy loading de dados |
| Complexidade do Recharts | Baixa | Médio | POC inicial, documentação detalhada |
| Cálculos financeiros incorretos | Baixa | Alto | Unit tests, validação com dados reais |

### Riscos de UX
| Risco | Probabilidade | Impacto | Mitigação |
|-------|--------------|---------|-----------|
| Interface confusa | Média | Médio | Testes com usuários, iteração rápida |
| Performance em mobile | Média | Médio | Design responsivo, otimização |

## Dependências
- **Pré-requisitos**: Dados históricos populados via `FinancialDataFetcher`
- **Integração**: Models `Ativo`, `DadoHistorico`, `Cesta`, `Portfolio`
- **Design System**: shadcn/ui components existentes

## Métricas de Sucesso
- [x] Tempo de carregamento < 2s para gráficos com 1 ano de dados
- [x] Interface responsiva em dispositivos 320px+
- [x] Cobertura de testes > 80% para lógica de cálculos
- [x] Feedback positivo em testes de usabilidade

## Notas de Implementação
1. ✅ Utilizar memo/useMemo para otimização de re-renders
2. ✅ Implementar error boundaries para handling de erros
3. ✅ Considerar skeleton loading durante fetch de dados
4. ✅ Manter consistência com padrões de design existentes

## Implementações Realizadas - UI/UX Improvements

### Fase 1: Core UX Components
- ✅ **ChartSkeleton.tsx**: Loading states realistas com animação SVG
- ✅ **EmptyStateCard.tsx**: Estados vazios contextuais com call-to-actions
- ✅ **ProgressiveLoader.tsx**: Loading multi-stage com feedback visual
- ✅ **ErrorBoundaryCard.tsx**: Error handling inteligente com sugestões de correção

### Fase 2: Enhanced Interactions
- ✅ **AssetSelector.tsx**: Componente avançado com busca, filtros por tipo e multi-seleção
- ✅ **TimeRangeSelector.tsx**: Seletor de período com suporte a custom dates
- ✅ **TimeSeriesChart.tsx**: Gráfico com zoom, pan e brush interativo
- ✅ **MobileDrawer.tsx**: Drawer responsivo para controles mobile
- ✅ **ComparisonChart.tsx**: Comparação multi-asset com cores dinâmicas

### Fase 3: Polish & Performance
- ✅ **Sistema de Animações**: 8+ animações CSS customizadas (fade-in, scale, slide)
- ✅ **Responsividade Completa**: Design mobile-first com breakpoints otimizados
- ✅ **Performance Optimizations**: React.memo, useMemo, query optimization
- ✅ **Separação de Queries**: Queries independentes para single/normalized/comparison

### Correções Críticas Realizadas
- ✅ **Chart Data Separation**: Queries separadas evitam conflitos entre abas
- ✅ **ResponsiveContainer Fix**: Estrutura correta para renderização de gráficos
- ✅ **SSR Compatibility**: Remoção de dependências client-only
- ✅ **Asset Selector Background**: Background opacity fixado para melhor UX

### Funcionalidades Implementadas
- ✅ **3 Tipos de Visualização**: Único (preços), Retorno (normalizado), Compare (multi-asset)  
- ✅ **6 Períodos de Tempo**: 30d, 90d, 365d, 1y, 3y, 5y
- ✅ **Interações Avançadas**: Zoom, pan, brush selection, tooltips customizados
- ✅ **Estados Completos**: Loading, empty, error com recovery actions
- ✅ **Mobile Experience**: Drawer controls, touch-friendly interactions

---
**Criado por**: John (Product Manager)
**Data**: 02/01/2025
**Status**: ✅ **Completado** - 02/09/2025