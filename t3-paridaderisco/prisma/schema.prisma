// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 1. Definição dos Enums (Tipos de Dados Customizados)
enum AssetCalculationType {
  PRECO      // Para ativos como Ações, ETFs
  PERCENTUAL // Para ativos como CDI
}

enum TransactionType {
  COMPRA
  VENDA
}

enum UserRole {
  ADMIN
  USER
}

// 2. Definição dos Modelos (Tabelas)
model User {
  id              String      @id @default(cuid())
  name            String
  email           String      @unique
  phone           String
  password        String
  image           String?
  role            UserRole    @default(USER)
  selectedBasketId String?
  dataNascimento  DateTime?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  cestas                  Cesta[]
  selectedBasket          Cesta?  @relation("UserSelectedBasket", fields: [selectedBasketId], references: [id], onDelete: SetNull)
  portfolio               Portfolio?
  transacoes              Transacao[]
  fundosInvestimento      FundoInvestimento[]
  simulacoesAposentadoria SimulacaoAposentadoria[]
  notifications           Notification[]
  chats                   Chat[]
}

model Portfolio {
  id          String   @id @default(cuid())
  cashBalance Decimal  @db.Decimal(12, 2)
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id])
}

model Cesta {
  id         String           @id @default(cuid())
  name       String
  userId     String
  user       User             @relation(fields: [userId], references: [id])
  ativos     AtivosEmCestas[]
  usersWithThisBasketSelected User[] @relation("UserSelectedBasket")
}

model Ativo {
  id              String               @id @default(cuid())
  ticker          String               @unique
  name            String
  type            String
  calculationType AssetCalculationType
  dadosHistoricos DadoHistorico[]
  cestas          AtivosEmCestas[]
  transacoes      Transacao[]
  fundos          FundoInvestimento[]  @relation("FundoIndice")
}

model AtivosEmCestas {
  cestaId          String
  cesta            Cesta            @relation(fields: [cestaId], references: [id])
  ativoId          String
  ativo            Ativo            @relation(fields: [ativoId], references: [id])
  targetPercentage Decimal          @db.Decimal(5, 2)

  @@id([cestaId, ativoId])
}

model DadoHistorico {
  id      String    @id @default(cuid())
  date    DateTime
  price   Decimal?  @db.Decimal(10, 4)
  ativoId String
  ativo   Ativo     @relation(fields: [ativoId], references: [id])

  @@unique([ativoId, date])
}

model Transacao {
  id            String          @id @default(cuid())
  type          TransactionType
  shares        Decimal         @db.Decimal(18, 8)
  pricePerShare Decimal         @db.Decimal(10, 2)
  date          DateTime
  
  ativoId       String
  ativo         Ativo           @relation(fields: [ativoId], references: [id])
  
  userId        String
  user          User            @relation(fields: [userId], references: [id])
}

model FundoInvestimento {
  id                String   @id @default(cuid())
  name              String
  initialInvestment Decimal  @db.Decimal(12, 2)
  currentValue      Decimal  @db.Decimal(12, 2)
  investmentDate    DateTime
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  userId            String
  user              User     @relation(fields: [userId], references: [id])

  // Associação com índice
  indiceId          String?
  indice            Ativo?   @relation("FundoIndice", fields: [indiceId], references: [id])

  @@index([userId])
  @@index([indiceId])
}

model SimulacaoAposentadoria {
  id        String   @id @default(cuid())
  name      String   // Nome da simulação para referência

  // Situação Atual
  idadeAtual         Int
  patrimonioInicial  Decimal  @db.Decimal(15, 2)
  aporteMensal       Decimal  @db.Decimal(12, 2)

  // Objetivos
  idadeAposentadoria        Int
  valorReceberAnualDesejado Decimal  @db.Decimal(12, 2)
  periodoUsufruir           Int

  // Premissas (armazenadas como percentuais: 12.5 para 12.5%)
  previsaoInflacaoAnual   Decimal  @db.Decimal(5, 2)
  taxaRealAcumulacao      Decimal  @db.Decimal(5, 2)
  taxaRealAposentadoria   Decimal  @db.Decimal(5, 2)
  aliquotaIR              Decimal  @db.Decimal(5, 2) @default(15.0) // Alíquota de IR sobre rendimentos

  // Resultados Calculados
  patrimonioNecessario Decimal  @db.Decimal(15, 2)
  patrimonioAcumulado  Decimal  @db.Decimal(15, 2)
  valorPrimeiroSaque   Decimal  @db.Decimal(12, 2)
  resultado            Decimal  @db.Decimal(15, 2) // Superávit (positivo) ou Déficit (negativo)
  planoViavel          Boolean

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userId    String
  user      User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([createdAt])
}

// 3. Modelos para RAG (Retrieval-Augmented Generation)

enum ResourceCategory {
  STRATEGY           // Estratégias de investimento
  MARKET_ANALYSIS    // Análises de mercado
  INVESTMENT_GUIDE   // Guias de investimento
  RISK_PARITY        // Paridade de Risco específico
  ASSET_INFO         // Informações sobre ativos
  ECONOMIC_SCENARIO  // Cenários macroeconômicos
}

enum NotificationType {
  INSIGHT       // Insights gerais sobre o portfólio
  WARNING       // Alertas importantes
  OPPORTUNITY   // Oportunidades identificadas
  REBALANCE     // Sugestões de rebalanceamento
}

enum NotificationPriority {
  HIGH
  MEDIUM
  LOW
}

model Resource {
  id          String           @id @default(cuid())
  title       String
  content     String           @db.Text
  category    ResourceCategory
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  embeddings  Embedding[]

  @@index([category])
  @@index([createdAt])
}

model Embedding {
  id         String                    @id @default(cuid())
  resourceId String
  content    String                    @db.Text
  embedding  Unsupported("vector(768)")
  resource   Resource                  @relation(fields: [resourceId], references: [id], onDelete: Cascade)

  @@index([resourceId])
}

model Notification {
  id        String               @id @default(cuid())
  userId    String
  title     String
  message   String               @db.Text
  type      NotificationType
  priority  NotificationPriority
  read      Boolean              @default(false)
  metadata  Json?                // Dados adicionais (ex: sugestões de trades, gráficos)
  createdAt DateTime             @default(now())
  user      User                 @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
  @@index([read])
}

model Chat {
  id        String   @id @default(cuid())
  title     String   @default("Nova conversa")
  messages  Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
}